import nmap
import database  # Ensure this import works

def scan_target(target_ip):
    print(f"Starting scan on {target_ip}")
    scanner = nmap.PortScanner()
    scan_result = scanner.scan(target_ip, '1-1024')  # Scans the first 1024 ports
    print(scan_result)  # Print the raw scan result
    return scan_result

def parse_results(result):
    print("Parsing results...")
    print(result)  # Print the raw result for debugging

    # Check for 'scan' key in the result
    if 'scan' in result:
        for host, info in result['scan'].items():
            print(f"Host: {host} (up)")

            # Iterate over all protocols (like 'tcp', 'udp', etc.)
            for protocol in info.keys():
                if protocol in ['tcp', 'udp']:
                    print(f"Protocol: {protocol}")

                    # Get all ports for the protocol
                    ports = info[protocol].keys()

                    # Iterate through all the ports
                    for port in ports:
                        state = info[protocol][port]['state']
                        service = info[protocol][port]['name']
                        print(f"Port: {port}, State: {state}, Service: {service}")

                        # Save result to database
                        database.save_result(host, port, state, service)
    else:
        print("No 'scan' key found in scan result.")

def main():
    target = input("Enter the target IP address: ")
    result = scan_target(target)
    parse_results(result)

if __name__ == "__main__":
    main()
